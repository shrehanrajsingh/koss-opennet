{% extends 'base.html' %}
{% block title %}Post - OpenNet{% endblock %}

{% block content %}
<div class="view-header">
    <a href="{{ url_for('posts.feed') }}" style="color: var(--text-primary); text-decoration: none; display: flex; align-items: center; gap: 16px;">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        <span class="header-title">Post</span>
    </a>
</div>

<!-- Original Post -->
<div class="post" style="border-bottom: 1px solid var(--border-color);">
    <div class="post-avatar">
        <img src="{{ url_for('upload.serve_upload', filename=post.profile_pic) }}" 
             class="create-avatar"
             onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/default_avatar.png') }}'">
    </div>
    
    <div class="post-content">
        <div class="post-header-line">
            <div class="user-meta">
                <a href="{{ url_for('profile.view_profile', id=post.user_id) }}" style="text-decoration: none;">
                    <span class="display-name">{{ post.username }}</span>
                </a>
                <span class="username">@{{ post.username }}</span>
                <span class="time">· {{ post.created_at.split()[1][:5] if post.created_at else '' }}</span>
            </div>
        </div>
        
        <div class="post-text" style="font-size: 17px; line-height: 1.5;">
            {{ post.content|safe }}
        </div>

        {% if post.image_url %}
        <div class="post-image" style="margin-top: 10px; margin-bottom: 5px;">
            <img src="{{ url_for('upload.serve_upload', filename=post.image_url) }}" 
                 style="max-width: 100%; border-radius: 16px; border: 1px solid var(--border-color);"
                 onerror="this.style.display='none'">
        </div>
        {% endif %}
        
        <div style="padding: 16px 0; border-top: 1px solid var(--border-color); margin-top: 16px; color: var(--text-secondary); font-size: 14px;">
            {{ post.created_at }}
        </div>
    </div>
</div>

<!-- Comments Section -->
<div style="padding: 16px;">
    <h3 style="color: var(--text-primary); font-size: 20px; font-weight: bold; margin-bottom: 16px;">
        Comments ({{ comments|length }})
    </h3>
    
    <!-- Add Comment Form -->
    {% if current_user %}
    <div class="widget-card" style="margin-bottom: 24px;">
        <form method="POST" action="{{ url_for('posts.add_comment', post_id=post.id) }}">
            <div style="display: flex; gap: 12px;">
                <img src="{{ url_for('upload.serve_upload', filename=current_user.profile_pic) }}" 
                     class="create-avatar" style="width: 40px; height: 40px;"
                     onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/default_avatar.png') }}'">
                <div style="flex: 1;">
                    <textarea name="content" placeholder="Write a comment..." required
                        style="width: 100%; padding: 12px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 15px; min-height: 80px; resize: vertical; box-sizing: border-box;"></textarea>
                    <div style="display: flex; justify-content: flex-end; margin-top: 12px;">
                        <button type="submit" class="mini-post-btn">Reply</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    {% endif %}
    
    <!-- Comments List -->
    {% for comment in comments %}
    <div class="post" style="padding: 16px 0;">
        <div class="post-avatar">
            <img src="{{ url_for('upload.serve_upload', filename=comment.profile_pic) if comment.profile_pic else url_for('static', filename='img/default_avatar.png') }}" 
                 class="create-avatar" style="width: 40px; height: 40px;"
                 onerror="this.onerror=null;this.src='{{ url_for('static', filename='img/default_avatar.png') }}'">
        </div>
        <div class="post-content">
            <div class="post-header-line">
                <div class="user-meta">
                    <a href="{{ url_for('profile.view_profile', id=comment.user_id) }}" style="text-decoration: none;">
                        <span class="display-name">{{ comment.username }}</span>
                    </a>
                    <span class="username">@{{ comment.username }}</span>
                    <span class="time">· {{ comment.created_at.split()[1][:5] if comment.created_at else '' }}</span>
                </div>
            </div>
            <div class="post-text">
                {{ comment.content|safe }}
            </div>
        </div>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
        <p>No comments yet.</p>
        <p style="font-size: 14px; margin-top: 8px;">Be the first to comment!</p>
    </div>
    {% endfor %}
</div>
{% endblock %}
